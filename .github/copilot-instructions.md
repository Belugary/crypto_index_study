<!-- Copilot 自动化开发指南 -->

# 区块链资产指数研究项目开发指南

本指南为 AI 助手提供项目开发的核心原则、工作流和资产管理规范。

---

## 1. 核心原则与工作流

### 1.1. 项目目标与技术栈

- **核心目的**: 区块链资产指数研究与量化分析。
- **技术栈**: Python, CoinGecko API
- **数据源**: CoinGecko Pro API (通过 `.env` 文件配置)。

### 1.2. 代码风格与测试

- **注释**: 使用中文注释和详细的类型提示。
- **用户提示**: API 调用前后需有明确的状态提示信息。
- **测试**: 所有测试必须放在 `tests/` 目录，并覆盖新增的 API 功能。

### 1.3. 测试管理规范 (关键)

#### 测试完整性原则

- **重构后必须验证**: 任何架构重构后，必须立即运行完整测试套件 (`python -m pytest tests/ -v`)
- **测试引用同步**: 代码模块路径变更时，必须同步更新测试文件中的所有 import 和 mock 引用
- **测试结构匹配**: 测试架构必须与代码架构保持一致，移除对已删除函数/类的测试

#### 测试质量标准

- **100% 通过率**: 项目中不允许存在失败的测试，除非有明确的修复计划
- **覆盖核心功能**: 重点测试 API、更新器、分类器等核心业务逻辑
- **Mock 路径准确**: 所有 `@patch` 装饰器必须引用实际存在的模块路径

#### 测试维护流程

1. **架构变更检查**: 重构后检查所有测试文件的导入是否有效
2. **引用路径更新**: 使用 `grep_search` 工具查找并更新过时的模块引用
3. **测试结构优化**: 移除冗余测试，保留核心功能验证
4. **回归验证**: 确保所有测试通过后再提交代码

---

## 2. 配置与数据一致性 (重要)

### 2.1. 核心配置原则

- **目标导向**: 用户参数 (如 `target_native_coins=510`) 是**目标结果**，而非搜索限制。系统需自动调整内部逻辑（如扩展 API 查询范围）来达成该目标。
- **单一来源**: 关键配置应有唯一的定义源，其他地方引用而非重复定义。

### 2.2. 一致性检查清单

任何涉及核心配置的修改，必须使用 `grep_search` 等工具检查并同步更新以下所有相关项：

- **代码**: `scripts/` 和 `main.py` 中的默认参数、函数签名、帮助文档。
- **文档**: `README.md` 和本指南中的功能描述与数据范围。
- **测试**: 测试文件中的期望值。

---

## 3. 资产与文档管理

### 3.1. 数据资产

- **范围**: 市值前 800 名币种的日级别历史数据，原生币目标数默认为 510。
- **分类**: 自动识别并可选择排除稳定币 (80 个) 和包装币 (24 个)。
- **更新规范**:
  - **README**: 必须更新 `(最近更新: YYYY-MM-DD)`。
  - **Git 提交**: 必须使用 `📊 数据更新: ...` 格式。

### 3.2. 文件与日志

- **核心目录**: `src/` (核心代码), `scripts/` (自动化脚本), `tests/` (测试), `data/` (数据资产)。
- **日志**: 所有日志统一存放在根目录的 `logs/` 中。
- **禁止**: 根目录禁止创建任何临时脚本 (`test_*.py`, `temp_*.py` 等)。

### 3.2.1. 临时文件命名规范 (重要)

为确保临时文件自动被 Git 忽略，必须遵循以下命名模式：

**调试和测试文件**:

- `debug_*.py` - 调试脚本
- `temp_*.py` / `tmp_*.py` - 临时脚本
- `*_debug.py` / `*_temp.py` - 带后缀的调试文件
- `test_*_fix.py` / `*_testing.py` - 测试修复脚本
- `verify_*.py` / `check_*.py` / `inspect_*.py` - 验证检查脚本

**实验和原型**:

- `experiment_*.py` / `*_experiment.py` - 实验代码
- `prototype_*.py` / `*_prototype.py` - 原型代码
- `draft_*.py` / `*_draft.py` - 草稿代码
- `wip_*.py` / `*_wip.py` - 工作进行中的代码

**临时目录**:

- `debug/` / `temp/` / `tmp/` / `scratch/` / `playground/` - 临时工作目录

**重要**: 所有符合上述模式的文件会被 `.gitignore` 自动忽略，无需手动清理。

### 3.3. 文档管理

- **核心文档**: `README.md` (用户指南), `CHANGELOG.md` (更新日志), 本文件 (开发指南)。
- **同步性**: 代码更新后，必须同步更新所有相关文档。
- **README 优化原则**:
  - **用户视角**: 围绕“用户如何用、能得到什么结果”展开。
  - **简洁至上**: 突出核心价值和操作步骤，避免冗余技术细节。
  - **结构建议**: 快速开始和常用命令放前面，详细功能放后面。

### 3.4. Agent 上下文管理

- **核心原则**: 严格控制上下文大小，**严禁**在响应中列出 `data/` 目录下的海量文件内容或 diff。
- **执行细则**: 在 `git status` 等场景下，对 `data/` 目录的变更**必须**进行总结性描述（例如：“发现 N 个新的数据文件”）。

---

## 4. 变更管理与质量保证 (新增)

### 4.1. 重大变更标准流程

#### 变更前检查

1. **影响范围评估**: 使用 `grep_search` 工具检查变更对其他模块的影响
2. **依赖关系梳理**: 确认所有依赖该模块的代码和测试
3. **备用方案准备**: 重大重构前确保有回滚策略

#### 变更执行规范

1. **模块化推进**: 大型重构按模块逐步进行，避免一次性大改
2. **测试先行**: 重要功能变更前先更新对应的测试用例
3. **文档同步**: 代码变更的同时更新相关文档

#### 变更后验证 (必需)

1. **完整测试运行**: `python -m pytest tests/ -v` 必须 100% 通过
2. **功能回归验证**: 运行核心脚本确保功能正常
3. **文档更新验证**: 检查 README.md、CHANGELOG.md 是否需要更新
4. **复盘记录创建**: 重大变更后必须创建复盘文档

### 4.2. 质量保证检查清单

#### 代码质量

- [ ] 所有测试通过 (53/53 ✅)
- [ ] 导入路径正确，无过时引用
- [ ] 代码结构清晰，职责单一
- [ ] 遵循项目命名规范

#### 文档质量

- [ ] CHANGELOG.md 记录变更内容
- [ ] README.md 反映最新功能
- [ ] 复盘文档总结经验教训
- [ ] 代码注释准确完整

#### 项目完整性

- [ ] 核心功能脚本可正常运行
- [ ] 数据更新日期准确
- [ ] Git 提交信息清晰规范
- [ ] 临时文件已清理

### 4.3. 复盘与改进

#### 复盘文档规范

- **存放位置**: `logs/*_retrospective_YYYYMMDD.md`
- **必需内容**: 问题分析、修复策略、成果评估、教训总结
- **格式标准**: 使用结构化模板，包含关键指标和时间线

#### 持续改进机制

- **经验沉淀**: 每次复盘的关键教训要融入开发指南
- **流程优化**: 定期评估开发流程，识别改进点
- **知识传承**: 重要经验形成制度化规范，避免重复犯错

---

## 5. 核心开发哲学 (根本原则)

### 5.1. 根因分析 (五问法)

在解决问题时，必须超越表象，探究根本原因。

**案例：数据分类错误**

- **第一层 (表象)**: 为什么原生币数量不足？
  - **答案**: 因为稳定币和包装币被过度分类，排除了过多的原生币。
- **第二层 (直接原因)**: 为什么会过度分类？
  - **答案**: 因为分类逻辑过于复杂，使用了宽泛的自定义关键词匹配。
- **第三层 (深层原因)**: 为什么会使用复杂的自定义逻辑？
  - **答案**: 因为不信任官方数据源的权威性，试图“做得更全面”。
- **第四层 (哲学原因)**: 为什么不信任权威数据源？
  - **答案**: 因为存在“过度工程化”的思维惯性，认为复杂的方案优于简单的方案。
- **第五层 (根本原因)**: **工程哲学偏差**。违背了“简单有效”的核心原则，陷入了对复杂性的盲目追求。

### 5.2. 必须遵循的原则

1.  **简单胜于复杂 (Simplicity First)**:

    - 遵循 Python 之禅，优先选择最简单、直接的解决方案。
    - **奥卡姆剃刀**: 如无必要，勿增实体。

2.  **信任权威数据源 (Authoritative Source Priority)**:

    - CoinGecko 的官方分类是第一权威，自定义逻辑只能作为补充。

3.  **用户导向设计 (User-Centric Design)**:
    - 用户参数表达的是**期望的结果**，系统应负责实现它。
    - 接口设计应符合用户直觉，而非暴露技术细节。

### 5.3. 可执行的预防措施

- **复杂性告警**: 一个函数或方法中的 `if/else` 嵌套超过 3 层，或条件判断超过 5 个，应被视为“代码异味”，需要重构。
- **依赖检查**: 代码审查时，必须检查是否优先依赖了官方或权威的字段/接口。

---

## 6. 技术实现重要提醒

### 6.1. 数据源架构 (关键)

#### 指数计算数据源

- **核心数据源**: `data/daily/daily_files/` 目录下的每日汇总数据
- **数据格式**: CSV 文件包含表头 `timestamp,price,volume,market_cap,date,coin_id,rank`
- **时间戳处理**:
  - ✅ **已修复**: CSV 文件包含表头行，pandas `read_csv()` 会自动正确处理
  - ❌ **过去错误**: 尝试将表头 "timestamp" 转换为时间戳导致错误
  - 📝 **解决方案**: 使用 `DailyDataAggregator` 统一处理数据访问

#### 数据读取最佳实践

```python
# ✅ 正确方式：使用每日数据聚合器
from src.downloaders.daily_aggregator import DailyDataAggregator
aggregator = DailyDataAggregator(output_dir="data/daily")
daily_data = aggregator.get_daily_data("2025-07-12")

# ❌ 错误方式：直接读取CSV并手动处理时间戳
df = pd.read_csv("data/coins/bitcoin.csv", header=None)  # 会导致表头问题
df['date'] = pd.to_datetime(df['timestamp'], unit='ms')  # 表头非数值
```

#### 指数计算器架构更新

- **MarketCapWeightedIndexCalculator**: 已更新为使用 `DailyDataAggregator`
- **向后兼容**: 保留原有构造函数参数，但实际使用每日汇总数据
- **性能优化**: 避免逐一读取数百个币种文件，改用预汇总数据

### 6.2. 错误诊断模式

#### 时间戳相关错误

```
ValueError: could not convert string to float: 'timestamp'
```

**根因**: CSV 文件包含表头，直接使用 `unit='ms'` 转换时间戳失败

**解决方案**:

1. 使用 `pd.read_csv()` 而非 `pd.read_csv(header=None)`
2. 通过 `DailyDataAggregator` 统一数据访问
3. 避免直接操作原始 CSV 文件

#### 分类器集成错误模式

**症状**: 分类器返回正确结果，但过滤逻辑不生效

**案例**: `wrapped-bitcoin` 检查器返回 `is_wrapped_coin: True`，但仍出现在指数成分中

**根因分析**:

1. **字段名不匹配**: 过滤代码使用 `is_wrapped` 而检查器返回 `is_wrapped_coin`
2. **分类不完整**: 液体质押代币 (`staked-ether`) 未被包装币检查器识别
3. **异常处理过宽**: `except Exception` 导致所有错误都被静默忽略

**解决方案**:

```python
# ❌ 错误方式
is_wrapped = wrapped_result.get("is_wrapped", False)  # 字段名错误

# ✅ 正确方式
is_wrapped = wrapped_result.get("is_wrapped_coin", False)  # 正确字段名

# 扩展包装币分类包含液体质押代币
wrapped_category_keywords = [
    "Wrapped-Tokens",
    "Liquid Staking Tokens",
    "Liquid Staked ETH",
    "Tokenized BTC"
]
```

**防范措施**:

1. **单元测试覆盖**: 测试已知的包装币/液体质押币是否被正确过滤
2. **字段名验证**: 确保分类器返回字段与过滤逻辑一致
3. **分类完整性**: 定期审查新出现的衍生品分类

### 6.3. 开发流程提醒

#### 数据相关变更

1. **测试数据访问**: 变更后立即运行指数计算测试
2. **更新文档**: 在本指南中记录数据格式变更
3. **向后兼容**: 确保现有脚本和示例正常工作

#### 错误处理模式

- **预防**: 优先使用已验证的数据访问类
- **诊断**: 错误发生时检查数据格式假设
- **修复**: 更新架构而非修补症状
- **记录**: 在指南中记录解决方案防止重复
