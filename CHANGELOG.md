# 更新日志

所有更都将记录在此文件中。

本项目遵循 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/) 格式，并使用 [语义化版本](https://semver.org/lang/zh-CN/)。

---

## [未发布] - 2025-07-12

### 🧪 测试系统现代化

- **修复过时测试引用**: 更新所有测试文件中的过时模块引用

  - 修正 `PriceDataUpdater` 导入路径：`scripts.update_price_data` → `src.updaters.price_updater`
  - 更新所有 `patch` 装饰器的引用路径，匹配重构后的代码结构
  - 移除对不存在函数的测试（如 `get_all_coin_ids_from_data`, `batch_update_all_metadata` 等）

- **测试结构重构**: 简化测试架构，聚焦核心功能

  - 创建 `TestMetadataUpdaterIntegration` 类，专门测试 `MetadataUpdater` 集成功能
  - 保留脚本层的主流程测试，确保调用关系正确
  - 移除冗余的单独函数测试，改为测试实际的类方法

- **测试质量提升**:
  - **29 个测试** 全部通过，100% 成功率 ✅
  - 测试现在与当前代码架构完全匹配
  - 提供可靠的重构安全保障

### 🏗️ 重大架构重构

- **核心功能模块化**: 创建 `src/updaters/` 模块，将核心业务逻辑从脚本层分离

  - 新增 `src/updaters/price_updater.py`: 价格数据智能更新核心逻辑
    - `CoinClassifier`: 币种分类器，基于 CoinGecko 官方分类
    - `MarketDataFetcher`: 市场数据获取器，支持按市值排名获取
    - `PriceDataUpdater`: 智能更新策略，自动达成目标原生币数量
  - 新增 `src/updaters/metadata_updater.py`: 元数据批量管理核心逻辑
    - `MetadataUpdater`: 提供完整的元数据管理功能
    - 支持增量更新和强制更新模式
    - 自动生成稳定币、包装币、原生币分类列表

- **脚本层简化**: 将 scripts 重构为薄封装层

  - `scripts/update_price_data.py`: 从 562 行复杂逻辑简化为 70 行脚本调用
  - `scripts/update_all_metadata.py`: 从 412 行复杂逻辑简化为 90 行脚本调用
  - 保持完全的向后兼容性，用户接口无变化

- **代码架构优化**: 符合开发指南的核心原则
  - 简单胜于复杂：每个模块职责单一，脚本层极简
  - 信任权威数据源：保持基于 CoinGecko 官方分类的逻辑
  - 用户导向设计：核心功能可复用，脚本接口保持不变
  - 提升可测试性：核心类可独立测试和复用

### 🧹 项目清理

- 删除根目录临时文档文件 (`temp_*.md`)
- 清理 scripts 目录多余的副本文件
- 删除空的 debug 目录
- 清理编译缓存文件

### � 文档更新

- 更新 README.md 目录结构，反映新的模块组织
- 添加核心更新模块的使用示例
- 更新 CHANGELOG.md 记录重构历程

### �🚀 新功能

- **智能价格更新器重构**: 完全重写 `scripts/update_price_data.py`，基于重构设计哲学
  - 简单胜于复杂：每个方法职责单一，避免过度工程化
  - 信任权威数据源：基于 CoinGecko 官方分类，无复杂自定义逻辑
  - 用户导向设计：确保原生币达到目标数量，同时更新遇到的非原生币
- **智能搜索范围扩展**: 系统自动调整搜索范围，确保达到 510 个原生币种目标
- **增量每日数据更新**: 新增脚本 `scripts/incremental_daily_update.py` 与模块 `src/updaters/incremental_daily_updater.py`，支持新币种检测与历史数据集成；新增测试 `tests/test_incremental_daily_updater.py` 覆盖核心逻辑。

### 🔧 架构重构

- **数据获取架构重构**: 将数据管理功能从 `src/data/` 重组为 `src/downloaders/`

  - 创建 `src/downloaders/` 模块，突出数据获取功能的重要性
  - 统一数据获取概念：批量下载器和每日聚合器都属于数据获取工具
  - 更新所有相关导入路径：脚本、示例、测试和分类器模块
  - 优化模块文档和说明，提升代码可读性

- **分类器模块重构**: 将币种分类功能从 `examples/` 迁移到 `src/classification/`
  - 创建 `src/classification/` 模块，建立清晰的业务逻辑层
  - 迁移 `StablecoinChecker` 和 `WrappedCoinChecker` 到新位置
  - 修复依赖倒置问题：Scripts 不再依赖 Examples
  - 创建新的分类器使用示例：`examples/classification_example.py`
- **预留分析模块**: 创建 `src/analysis/` 模块，为未来指数计算功能预留
- **代码组织优化**: 建立清晰的职责分离，符合"区块链资产指数研究"项目定位

### � 新功能

- **智能价格更新器**: 新增 `scripts/smart_price_updater.py`，基于重构设计哲学
  - 简单胜于复杂：每个方法职责单一，避免过度工程化
  - 信任权威数据源：基于 CoinGecko 官方分类，无复杂自定义逻辑
  - 用户导向设计：确保原生币达到目标数量，同时更新遇到的非原生币
- **智能搜索范围扩展**: 系统自动调整搜索范围，确保达到 510 个原生币种目标

### 📊 数据更新

- **量价数据智能更新**: 在市值前 565 名币种中成功识别并确保 510 个原生币种数据最新
- **增量更新优化**: 只对需要更新的币种（如 entangle）进行增量下载，避免重复工作
- **数据范围扩展**: 搜索范围从 600 名扩展到 800 名，提升数据覆盖度
- **分类准确性**: 基于 CoinGecko 官方标签，稳定币（80 个）和包装币（24 个）分类更精准
- **性能提升**: 更新耗时仅 4 秒，处理速度达到 5000+ 币种/秒（检查阶段）

### 🔧 改进

- **配置一致性**: 统一所有文件中的数据范围描述（600→800）
- **文档优化**: 更新 README.md 推荐使用智能更新器
- **代码重构**: 移除了旧版本中的冗余二次过滤逻辑

---

## [未发布] - 2025-07-11

### 🎉 重大改进

#### 原生币数量配置功能

- **新增 `--native-coins` 参数**: 支持用户自定义目标原生币数量（默认 510）
- **动态搜索范围扩展**: 实现智能搜索范围自动调整机制，确保能够获得足够的原生币
- **智能增量策略**: 根据缺口大小采用不同增量（500/300/200），优化搜索效率
- **目标导向设计**: 参数作为目标结果而非搜索限制，系统自动调整内部逻辑实现目标

#### 数据分类优化

- **修复稳定币分类**: 从过度分类的 126 个减少到准确的 80 个稳定币
- **修复包装币分类**: 从过度分类的 157 个减少到准确的 24 个包装币
- **严格分类标准**: 仅使用 CoinGecko 官方分类标签，避免自定义逻辑导致的误判

#### 数据范围扩展

- **数据规模**: 从 528 个币种扩展到 638 个币种
- **原生币达标**: 成功获得 534 个原生币，超过 500 个目标
- **数据质量**: 通过严格分类确保数据的准确性和可靠性

### 🔧 技术改进

#### 配置管理优化

- **一致性检查**: 建立了完整的配置一致性检查流程
- **文档同步**: 更新所有相关文档中的数值和描述
- **错误防范**: 增加了阶段性成果验证流程

#### 开发指南完善

- **数据分类严格性原则**: 新增章节，确保未来分类的准确性
- **阶段性成果验证流程**: 新增质量保证检查清单
- **配置变更流程**: 完善了变更管理最佳实践

### 📊 数据统计

- **总币种数**: 638 个 (↑ 110 个)
- **原生币数**: 534 个 (↑ 290 个)
- **稳定币数**: 80 个 (↓ 46 个)
- **包装币数**: 24 个 (↓ 133 个)

### ✨ 新增 (Added)

- **原生币配置系统**:

  - 新增 `--native-coins` 命令行参数，支持自定义目标原生币数量
  - 实现动态搜索范围扩展算法，自动调整搜索范围直到达成目标
  - 添加智能增量策略，基于缺口大小优化搜索效率
  - 提供详细的配置信息显示，包括"动态扩展"状态说明

- **包装币识别系统**:
  - 新增 `examples/wrapped_coin_checker.py` 包装币检测器
  - 基于 CoinGecko 官方分类标签进行精确识别
  - 支持识别包装代币、桥接代币、液态质押代币、代币化资产等
  - 自动排除 meme 币和治理代币，避免误判
  - 导出包装币清单到 CSV 文件

### 🔧 优化 (Changed)

- **搜索逻辑重构**:

  - 修正参数处理逻辑，将用户参数从"搜索限制"改为"目标结果"
  - 实现最大搜索范围动态计算：`max(target * 2, 2000)`
  - 优化增量扩展策略，避免无效的固定范围限制

- **代码整理**:
  - 清理临时文件和重复代码
  - 统一包装币检测器命名 (`WrappedCoinChecker`)
  - 重构文件结构，提高代码可维护性

### 🐛 修复 (Fixed)

- **参数逻辑错误**:

  - 修复将用户参数误解为"搜索限制"而非"目标结果"的根本性错误
  - 修正 `max_search_range` 计算逻辑，确保搜索范围足够大
  - 解决边界测试中暴露的核心逻辑缺陷

- **包装币分类精度**:
  - 修复 SPX6900 等 meme 币被错误识别为包装币的问题
  - 修复 BTC 衍生物被错误归类为 ETH 质押代币的问题
  - 修复 sUSDe 等收益型稳定币分类不准确的问题

---

## [1.2.1] - 2025-07-11

### 🐛 修复 (Fixed)

- **配置一致性修复**:
  - 统一项目中所有"前 500 名币种"的配置，解决了部分地方显示 300 的不一致问题
  - 修复 `scripts/update_price_data.py` 中所有默认参数为 500
  - 更新 `README.md` 中的功能描述保持一致性
  - 修正命令行帮助文档的默认值说明

### 🔧 优化 (Changed)

- **代码架构改进**:
  - `PriceDataUpdater` 增强依赖注入支持，构造函数支持可选的 `api`、`downloader`、`checker` 参数
  - 添加稳定币检查逻辑，主处理循环中自动跳过稳定币处理
  - 改进测试架构，支持更好的单元测试隔离

### ✨ 新增 (Added)

- **开发指南升级**:
  - 新增"配置一致性原则"章节，建立配置变更的标准流程
  - 建立完整的一致性检查清单，涵盖代码、文档、配置三个层面
  - 新增"变更管理最佳实践"，提供深层架构防范措施
  - 定义单一数据源原则、依赖注入模式等架构设计准则

---

## [1.2.0] - 2025-07-11

### ✨ 新增 (Added)

- **文档管理系统**:
  - 创建 `CHANGELOG.md` 用于记录版本历史。
  - 添加 `docs/` 目录和详细的下载状态说明。
- **日志管理系统**:
  - 统一所有日志到根目录 `logs/`。

### 🔧 优化 (Changed)

- **文档结构**:
  - 重构 `README.md`，突出核心功能和使用示例。
  - 优化 `copilot-instructions.md`，使其更清晰、简洁。
- **Git 配置**:
  - 优化 `.gitignore`，允许同步开发指南，同时保护敏感信息。
- **代码质量**:
  - 移除未使用的 `os` 导入，规范化代码格式。

### 🐛 修复 (Fixed)

- **路径引用**: 修复了 `BatchDownloader` 中错误的日志路径。
- **文档一致性**: 统一了所有文档中的数据范围、路径引用和功能描述。

---

## [1.1.0] - 2025-07-11

### ✨ 新增 (Added)

- **价格数据更新系统**:
  - `scripts/update_price_data.py` 实现完整的增量更新。
  - 自动发现和更新 Top 500 市值币种。
  - 实时进度跟踪和新币种自动集成。

### 🚀 性能优化 (Performance)

- **API 调用**: 优化至 461.5 calls/min (0.13s 间隔)。
- **执行效率**: 更新时间从 10+ 分钟降至 16.8 秒 (99.5% 节省)。

### 📊 数据资产 (Data)

- **范围扩展**: 数据覆盖从 Top 300 扩展到 Top 500。
- **数据更新**: 更新了 500+ 币种的价格数据，新增 11 个币种。

---

## [1.0.0] - 2025-07-10

### ✨ 新增 (Added)

- **项目基础架构**:
  - 建立核心目录结构 (`src/`, `data/`, `tests/`)。
  - 完整的 CoinGecko Pro API 客户端 (`src/api/coingecko.py`)。
- **元数据管理系统**:
  - `scripts/update_all_metadata.py` 用于更新元数据和稳定币信息。
- **批量下载器**:
  - `src/data/batch_downloader.py` 支持智能批量下载和缓存。
- **测试系统**:
  - `tests/` 目录包含全面的 API 测试覆盖。

---
