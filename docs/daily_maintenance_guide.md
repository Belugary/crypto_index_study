# 每日维护脚本使用指南

## 概述

为了简化每日数据维护工作，我们提供了两个脚本：

- **`daily_maintenance.py`** - 完整功能的每日维护脚本
- **`quick_maintenance.py`** - 常用场景的快速启动脚本

## 工作流程

### 自动化维护流程

1. **用户配置** - 询问目标币种数量、并发线程数等参数
2. **排名数据获取** - 通过 CoinGecko API 获取最新市值排名
3. **价格数据更新** - 并发更新现有币种的价格数据
4. **数据完整性检测** - 智能检测每日汇总数据的缺失天数
5. **每日数据重建** - 自动重建缺失或不完整的每日数据
6. **维护报告** - 生成详细的执行报告

### 智能检测机制

- **文件存在性检测** - 检查最近 7 天的每日数据文件
- **文件完整性检测** - 检查文件大小（小于 10KB 视为不完整）
- **自动缺失补全** - 只重建真正需要的数据，避免无意义的重复工作

## 使用方法

### 🚀 快速使用（推荐）

```bash
# 每日例行维护（500个币种，智能检测）
python scripts/quick_maintenance.py

# 只同步daily数据（跳过价格更新）
python scripts/quick_maintenance.py --sync-only

# 完整更新（价格+daily数据）
python scripts/quick_maintenance.py --full
```

### 🔧 高级配置

```bash
# 交互式配置（推荐新用户）
python scripts/daily_maintenance.py

# 自动模式，500个币种
python scripts/daily_maintenance.py --auto --coins 500

# 自定义币种数量和线程数
python scripts/daily_maintenance.py --auto --coins 300 --workers 4

# 只重建daily数据，跳过价格更新
python scripts/daily_maintenance.py --auto --coins 500 --skip-price
```

## 参数说明

### daily_maintenance.py 参数

| 参数           | 说明               | 默认值 |
| -------------- | ------------------ | ------ |
| `--auto`       | 自动模式，无需交互 | False  |
| `--coins`      | 目标原生币种数量   | 500    |
| `--workers`    | 并发下载线程数     | 6      |
| `--skip-price` | 跳过价格数据更新   | False  |

### quick_maintenance.py 选项

| 选项          | 说明                               |
| ------------- | ---------------------------------- |
| 无参数        | 每日例行维护（500 币种，智能检测） |
| `--sync-only` | 只同步 daily 数据                  |
| `--full`      | 完整更新（价格+daily）             |
| `--help`      | 显示帮助信息                       |

## 使用场景

### 📅 每日例行维护

```bash
# 最常用：每天运行一次，确保数据最新
python scripts/quick_maintenance.py
```

### 🔄 快速数据同步

```bash
# 价格数据已是最新，只需重建daily汇总
python scripts/quick_maintenance.py --sync-only
```

### 🚀 完整数据重建

```bash
# 长时间未更新，需要完整的价格和daily数据更新
python scripts/quick_maintenance.py --full
```

### 🎯 自定义维护

```bash
# 只关心前300个币种，使用8个线程并发
python scripts/daily_maintenance.py --auto --coins 300 --workers 8
```

## 输出示例

### 成功执行

```
🔧 每日维护一键脚本
============================================================
📅 今日维护日期: 2025年07月13日
🎯 维护内容: 价格数据更新 + 每日汇总重建
⚡ 设计理念: 一键执行，智能检测，友好反馈
============================================================

🤖 自动模式启动
📊 配置: 500个币种, 6线程, 跳过价格更新: False

📈 开始价格数据更新...
🎯 目标: 确保 500 个原生币种数据最新
🔍 搜索范围: 市值前 700 名
🚀 并发线程: 6

✅ 价格数据更新完成

🔍 检测每日汇总数据完整性...
✅ 完整: 2025-07-13 (90KB)
✅ 完整: 2025-07-12 (94KB)
❌ 缺失: 2025-07-11
📋 发现 1 天数据需要重建

🔨 开始重建每日汇总数据...
📅 重建范围: 2025-07-11 到 2025-07-11
📊 涉及天数: 1

✅ 每日数据重建完成

📊 维护报告
========================================
🕐 维护时间: 2025-07-13 15:30:45
🎯 目标币种: 500 个原生币种
🔍 搜索范围: 前 700 名
📈 价格更新: 已执行
📊 数据重建: 1 天
✅ 执行状态: 成功
📅 重建日期: 07-11
📁 今日数据: 90KB
========================================
🎉 每日维护完成！数据已是最新状态。
```

## 最佳实践

### 🕐 推荐执行时间

- **每日维护**: 上午 10 点（市场数据相对稳定）
- **周末补充**: 周末检查一次本周数据完整性

### 💡 使用建议

1. **日常使用**: 优先使用 `quick_maintenance.py`，简单快捷
2. **首次运行**: 使用 `daily_maintenance.py` 交互式配置，了解各参数含义
3. **自动化部署**: 使用自动模式，可集成到 cron 或其他调度系统
4. **故障排查**: 查看 `logs/daily_maintenance.log` 获取详细信息

### ⚠️ 注意事项

- 网络不稳定时适当减少 `--workers` 参数
- CoinGecko API 有频率限制，建议间隔至少 30 分钟再次运行
- 大量数据重建时会占用较多内存，建议关闭其他大型程序

## 故障排查

### 常见问题

1. **网络连接失败**

   - 检查网络连接
   - 减少并发线程数（`--workers 2`）
   - 稍后重试

2. **内存不足**

   - 减少并发线程数
   - 分批处理（减少 `--coins` 参数）

3. **文件权限错误**

   - 检查 `data/` 目录写权限
   - 确保日志目录可写

4. **API 配额超限**
   - 等待 API 配额重置（通常 1 小时）
   - 使用 `--skip-price` 跳过价格更新

### 日志文件

- **主日志**: `logs/daily_maintenance.log`
- **价格更新**: `logs/update_all_existing_coins.log`
- **每日汇总**: `logs/daily_aggregation.log`

## 技术实现

### 核心组件

- **DailyMaintenanceManager**: 维护流程管理
- **智能检测**: 自动发现缺失数据
- **并发更新**: 多线程价格数据下载
- **容错处理**: 优雅的错误恢复机制

### 设计哲学

- **一键执行**: 减少重复的手动操作
- **智能检测**: 只做必要的工作，避免浪费
- **友好反馈**: 清晰的进度显示和状态报告
- **容错处理**: 异常情况下的优雅降级

---

**💡 提示**: 如果您是第一次使用，建议先运行 `python scripts/daily_maintenance.py` 熟悉各个参数，然后在日常使用中切换到 `quick_maintenance.py` 提高效率。
